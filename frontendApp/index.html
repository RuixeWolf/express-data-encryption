<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RSA 加密与解密</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Microsoft Yahei", "Hiragino Sans GB", "Helvetica Neue", Helvetica, tahoma, arial, Verdana, sans-serif, "WenQuanYi Micro Hei";
    }
    h2 {
      margin: 10px 0;
    }
    section {
      width: 500px;
      margin: 0 auto;
    }
    ol,
    ul {
      padding-left: 1em;
      margin: 10px 0;
    }
    ol > li,
    ul > li {
      margin-top: 10px;
    }
    ol > li:first-child,
    ul > li:first-child {
      margin-top: 0;
    }
    .ta-item {
      margin-top: 10px;
    }
    .ta-item:first-child {
      margin-top: 0;
    }
    .ta-text {
      margin-top: 6px;
      width: 100%;
      height: 100px;
    }
    input[type="file"] {
      width: 100%;
    }
  </style>
</head>
<body>
  <section>
    <h2>RSA 非对称加密通讯</h2>
    <ol>
      <li>本地生成 OpenSSL RSA 私钥与公钥</li>
      <li>生成私钥<br>
        <code>openssl genrsa -out rsa_1024_priv.pem 1024</code>
      </li>
      <li>生成公钥<br>
        <code>openssl rsa -pubout -in rsa_1024_priv.pem -out rsa_1024_pub.pem</code>
      </li>
      <li>自己加密：使用对方的公钥加密自己的原文，并将密文发送给对方</li>
      <li>对方加密：将自己的公钥发给对方，让对方使用自己的公钥加密原文</li>
      <li>解密：使用自己的私钥解密对方发送的密文</li>
    </ol>
  </section>

  <section>
    <div class="ta-item">
      <div>
        <label for="rsaPublicKey">对方的 RSA 公钥</label>
        <button onclick="importTextFromClipboard('#rsaPublicKey'), clearInput('#rsaPublicKeyFile')">从剪切板导入</button>
        <button onclick="clearInput('#rsaPublicKey, #rsaPublicKeyFile')">清空</button>
      </div>
      <textarea id="rsaPublicKey" class="ta-text" onchange="clearInput('#rsaPublicKeyFile')" placeholder="输入或导入 RSA 公钥"></textarea>
      <div>
        <input id="rsaPublicKeyFile" type="file" onchange="importTextFromFile(this.files, '#rsaPublicKey')">
      </div>
    </div>
    <div class="ta-item">
      <div>
        <label for="rsaPrivateKey">自己的 RSA 私钥</label>
        <button onclick="importTextFromClipboard('#rsaPrivateKey'), clearInput('#rsaPrivateKeyFile')">从剪切板导入</button>
        <button onclick="clearInput('#rsaPrivateKey, #rsaPrivateKeyFile')">清空</button>
      </div>
      <textarea id="rsaPrivateKey" class="ta-text" onchange="clearInput('#rsaPrivateKeyFile')" placeholder="输入或导入 RSA 私钥"></textarea>
      <div>
        <input id="rsaPrivateKeyFile" type="file" onchange="importTextFromFile(this.files, '#rsaPrivateKey')">
      </div>
    </div>
    <div class="ta-item">
      <div>
        <label for="originalText">原文</label>
        <button onclick="encryptAndCopy()">加密原文并复制密文</button>
        <button onclick="encryptClipboardAndCopy()">从剪切板导入原文加密并复制密文</button>
        <button onclick="copyInput('#originalText')">复制</button>
        <button onclick="clearInput('#originalText')">清空</button>
      </div>
      <textarea id="originalText" class="ta-text" placeholder="输入或导入原文"></textarea>
    </div>
    <div class="ta-item">
      <div>
        <label for="cipherText">密文</label>
        <button onclick="decryptAndCopy()">解密密文并复制原文</button>
        <button onclick="decryptClipboardAndCopy()">从剪切板导入密文解密并复制原文</button>
        <button onclick="copyInput('#cipherText')">复制</button>
        <button onclick="clearInput('#cipherText')">清空</button>
      </div>
      <textarea id="cipherText" class="ta-text" placeholder="输入或导入密文"></textarea>
    </div>
  </section>

  <section>
    <ul>
      <li>
        <a href="https://travistidwell.com/jsencrypt/">JSEncrypt</a>
      </li>
      <li>
        <a href="https://jquery.com/">jQuery</a>
      </li>
    </ul>
  </section>

  <!-- JavaScript -->
  <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/jsencrypt/3.1.0/jsencrypt.min.js"></script>
  <script>
    // 加密
    function rsaEncrypt(rsaPublicKey, originalText) {
      const crypt = new JSEncrypt()
      crypt.setPublicKey(rsaPublicKey)
      const encryptRes = crypt.encrypt(originalText)
      return encryptRes
    }

    // 解密
    function rsaDecrypt(rsaPrivateKey, cipherText) {
      const crypt = new JSEncrypt()
      crypt.setPrivateKey(rsaPrivateKey)
      const decryptRes = crypt.decrypt(cipherText)
      return decryptRes
    }

    // 清空输入
    function clearInput(targetEleSelector) {
      $(targetEleSelector).val('')
    }

    // 读取文件文本内容
    function readFileText(file, encoding) {
      return new Promise((resolve, reject) => {
        const fileRender = new FileReader()
        fileRender.readAsText(file, encoding)
        fileRender.onload = event => {
          resolve(fileRender.result)
        }
        fileRender.onerror = event => {
          reject(event)
        }
      })
    }

    // 从文件导入文本
    async function importTextFromFile(files, targetEleSelector) {
      const file = files[0]
      if (file) {
        const fileText = await readFileText(file, 'UTF-8')
        $(targetEleSelector).val(fileText)
      }
    }

    // 获取剪切板文本内容
    async function getClipboardText() {
      const clipboard = navigator.clipboard
      const clipboardText = await clipboard.readText()
      return clipboardText
    }

    // 设置剪切板文本内容
    async function setClipboardText(text) {
      const clipboard = navigator.clipboard
      await clipboard.writeText(text)
    }

    // 从剪切板导入文本
    async function importTextFromClipboard(targetEleSelector) {
      const clipboardText = await getClipboardText()
      $(targetEleSelector).val(clipboardText)
    }

    // 获取加密所需信息
    function getEncryptInfo() {
      const rsaPublicKey = $('#rsaPublicKey').val()
      const originalText = $('#originalText').val()
      if (!rsaPublicKey) {
        alert('请输入公钥')
        return false
      }
      if (!originalText) {
        alert('请输入原文')
        return false
      }
      return { rsaPublicKey, originalText }
    }

    // 加密并复制密文
    async function encryptAndCopy() {
      const { rsaPublicKey, originalText } = getEncryptInfo()
      if (!rsaPublicKey || !originalText) return
      const encryptRes = rsaEncrypt(rsaPublicKey, originalText)
      $('#cipherText').val(encryptRes)
      if (encryptRes) await setClipboardText(encryptRes)
    }

    // 从剪切板导入原文加密并复制密文
    async function encryptClipboardAndCopy() {
      await importTextFromClipboard('#originalText')
      await encryptAndCopy()
    }

    // 获取解密所需信息
    function getDecryptInfo() {
      const rsaPrivateKey = $('#rsaPrivateKey').val()
      const cipherText = $('#cipherText').val()
      if (!rsaPrivateKey) {
        alert('请输入私钥')
        return false
      }
      if (!cipherText) {
        alert('请输入密文')
        return false
      }
      return { rsaPrivateKey, cipherText }
    }

    // 解密并复制原文
    async function decryptAndCopy() {
      const { rsaPrivateKey, cipherText } = getDecryptInfo()
      if (!rsaPrivateKey || !cipherText) return
      const decryptRes = rsaDecrypt(rsaPrivateKey, cipherText)
      $('#originalText').val(decryptRes)
      if (decryptRes) await setClipboardText(decryptRes)
    }

    // 从剪切板导入密文解密并复制原文
    async function decryptClipboardAndCopy() {
      await importTextFromClipboard('#cipherText')
      await decryptAndCopy()
    }

    // 复制输入框内容
    async function copyInput(targetEleSelector) {
      const content = $(targetEleSelector).val()
      if (content) await setClipboardText(content)
    }

  </script>
</body>
</html>
